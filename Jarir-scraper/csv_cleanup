#!/usr/bin/env python3
# patch_jarir_csvs.py
import os, glob, re, shutil
import pandas as pd

DATA_DIR = "Jarir-scraper"   # adjust if your CSVs live elsewhere

# ------------------------- helpers ------------------------- #
def is_renewed(url: str) -> bool:
    """True if '/...renewed...' appears in the product URL."""
    return bool(re.search(r"/[^/]*renewed[^/]*-", str(url)))

def add_common_columns(path: str) -> None:
    """Add `price` + `renewed` columns to a CSV in-place."""
    df = pd.read_csv(path)

    # price: use sale_price_sar if available, otherwise regular_price_sar
    if "regular_price_sar" in df.columns and "price" not in df.columns:
        if "sale_price_sar" in df.columns:
            df["price"] = df["sale_price_sar"].combine_first(df["regular_price_sar"])
        else:
            df["price"] = df["regular_price_sar"]

    # renewed: only add if not already present
    if "renewed" not in df.columns and "product_url" in df.columns:
        df["renewed"] = df["product_url"] \
            .apply(is_renewed) \
            .map({True: "renewed", False: "new"})

    df.to_csv(path, index=False, encoding="utf-8-sig")
    print(f"Patched common columns in {os.path.basename(path)}")

# ------------------- 1) patch every CSV -------------------- #
for csv_path in glob.glob(os.path.join(DATA_DIR, "jarir_*.csv")):
    add_common_columns(csv_path)

# ------------------- 2) desktop → AIO ---------------------- #
desktop_csv = os.path.join(DATA_DIR, "jarir_desktops.csv")
if os.path.exists(desktop_csv):
    aio_csv = os.path.join(DATA_DIR, "jarir_AIO.csv")
    df = pd.read_csv(desktop_csv)
    df["product_type"] = "AIO"
    df.to_csv(aio_csv, index=False, encoding="utf-8-sig")
    os.remove(desktop_csv)
    print(f"✔ Renamed and patched {os.path.basename(desktop_csv)} → {os.path.basename(aio_csv)}")

# ------------------- 3) cpu  → desktops -------------------- #
cpu_csv = os.path.join(DATA_DIR, "jarir_cpu.csv")
if os.path.exists(cpu_csv):
    desktops_csv = os.path.join(DATA_DIR, "jarir_desktops.csv")  # now free
    df = pd.read_csv(cpu_csv)

    def fix_pt(pt: str) -> str:
        pt_l = str(pt).lower()
        return "Gaming Desktop" if "gaming" in pt_l else "Desktop Computer"

    df["product_type"] = df["product_type"].apply(fix_pt)
    df.to_csv(desktops_csv, index=False, encoding="utf-8-sig")
    os.remove(cpu_csv)
    print(f"✔ Renamed {os.path.basename(cpu_csv)} → {os.path.basename(desktops_csv)} and fixed product_type")

print("✅ All CSVs patched.")
